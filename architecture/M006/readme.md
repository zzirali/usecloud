<h2 align="center">

计算密集型服务应该如何架构？

</h2>

- [公众号文章链接](https://mp.weixin.qq.com/s/zQHSKQ-CGMynmK50n5DQcw)


首先我先构建一个长时间占用 cpu 资源的函数：[index.js](./index.js)


然后我在本地写一个请求压测工具:[test.js](./test.js)

这里我同时发起 10 次请求，观察 10 次请求的返回时间以及内部执行时间。

1. 阿里云函数 1 核 1G 计算单实例单并发

```log
总耗时: 1.902秒
返回内容 [
  '耗时时长：1570 -> {"data":499999999067109000,"time":1296}',
  '耗时时长：1572 -> {"data":499999999067109000,"time":1291}',
  '耗时时长：1591 -> {"data":499999999067109000,"time":1314}',
  '耗时时长：1594 -> {"data":499999999067109000,"time":1324}',
  '耗时时长：1617 -> {"data":499999999067109000,"time":1310}',
  '耗时时长：1645 -> {"data":499999999067109000,"time":1316}',
  '耗时时长：1646 -> {"data":499999999067109000,"time":1347}',
  '耗时时长：1705 -> {"data":499999999067109000,"time":1317}',
  '耗时时长：1689 -> {"data":499999999067109000,"time":1332}',
  '耗时时长：1873 -> {"data":499999999067109000,"time":1307}'
]
```

> 1vCPU 执行的时间大概在 1.5 秒，共有 10 个实例参与

2. 阿里云函数 1 核 1G 计算单实例 2 并发（一个函数同时收到两个请求）

```log
总耗时: 3.16秒
返回内容 [
  '耗时时长：1663 -> {"data":499999999067109000,"time":1298}',
  '耗时时长：1688 -> {"data":499999999067109000,"time":1310}',
  '耗时时长：1710 -> {"data":499999999067109000,"time":1335}',
  '耗时时长：1746 -> {"data":499999999067109000,"time":1298}',
  '耗时时长：1834 -> {"data":499999999067109000,"time":1370}',
  '耗时时长：2980 -> {"data":499999999067109000,"time":1330}',
  '耗时时长：2993 -> {"data":499999999067109000,"time":1307}',
  '耗时时长：3065 -> {"data":499999999067109000,"time":1323}',
  '耗时时长：3086 -> {"data":499999999067109000,"time":1378}',
  '耗时时长：3124 -> {"data":499999999067109000,"time":1332}'
]
```

> 这里可以看到有 5 个请求在 1.5 秒左右，另外 5 个请求在 3 秒左右，因为 CPU 一直被占用，所以请求被在执行时被挂起了，等待前面 5 个请求完成后，才处理的后面 5 个请求。这时有 5 个实例参与工作。

3. 容器服务 1 核 1G 单实例

```log
总耗时: 24.395秒
返回内容 [
  '耗时时长：1484 -> {"data":499999999067109000,"time":1213}',
  '耗时时长：2675 -> {"data":499999999067109000,"time":1222}',
  '耗时时长：5363 -> {"data":499999999067109000,"time":2693}',
  '耗时时长：8096 -> {"data":499999999067109000,"time":2731}',
  '耗时时长：10816 -> {"data":499999999067109000,"time":2713}',
  '耗时时长：13554 -> {"data":499999999067109000,"time":2699}',
  '耗时时长：16210 -> {"data":499999999067109000,"time":2681}',
  '耗时时长：18918 -> {"data":499999999067109000,"time":2714}',
  '耗时时长：21683 -> {"data":499999999067109000,"time":2749}',
  '耗时时长：24358 -> {"data":499999999067109000,"time":2676}'
]
```

> 可以看到 10 个请求在有序计算，请求在排队，10 个请求完全处理完达到了 24 秒

3. 容器服务 1 核 1G 10 个实例

```log
总耗时: 5.857秒
返回内容 [
  '耗时时长：1449 -> {"data":499999999067109000,"time":1236}',
  '耗时时长：1459 -> {"data":499999999067109000,"time":1242}',
  '耗时时长：1558 -> {"data":499999999067109000,"time":1346}',
  '耗时时长：1666 -> {"data":499999999067109000,"time":1423}',
  '耗时时长：1708 -> {"data":499999999067109000,"time":1249}',
  '耗时时长：2668 -> {"data":499999999067109000,"time":1210}',
  '耗时时长：2809 -> {"data":499999999067109000,"time":1247}',
  '耗时时长：2962 -> {"data":499999999067109000,"time":1332}',
  '耗时时长：3095 -> {"data":499999999067109000,"time":2895}',
  '耗时时长：3097 -> {"data":499999999067109000,"time":2726}'
]
```

> 10 个请求同时进入 10 个独立的实例，基本都在 3 秒内完成返回
